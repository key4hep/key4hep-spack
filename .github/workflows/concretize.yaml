on:
  push:
    branches:
    - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  concretize:
    strategy:
      matrix:
        image: [alma9, ubuntu22]
        build_type: [release, nightly]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start container
        run: |
            name=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
            if [ "${{ matrix.image }}" = "alma9" ]; then
              docker run --name container --privileged -v ${GITHUB_WORKSPACE}:/${name} -v ~/.cache/ccache:/root/.cache/ccache -d ghcr.io/key4hep/key4hep-images/alma9-cvmfs tail -f /dev/null
            elif [ "${{ matrix.image }}" = "ubuntu22" ]; then
              docker run --name container --privileged -v ${GITHUB_WORKSPACE}:/${name} -v ~/.cache/ccache:/root/.cache/ccache -d ghcr.io/key4hep/key4hep-images/ubuntu22-cvmfs tail -f /dev/null
            else
              echo "Unknown image"
              exit 1
            fi

      - name: Setup environment and concretize
        run: |
            name=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

            cat <<'EOF' > ${GITHUB_WORKSPACE}/script_container.sh
            set -e

            name=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')


            cd /
            ls -lah /
            ls -lah /key4hep-spack

            git clone https://github.com/spack/spack -q
            source spack/share/spack/setup-env.sh

            cd /spack
            git checkout $(cat /${name}/.latest-commit)
            source /${name}/.cherry-pick

            if [ "${{ matrix.build_type }}" = "release" ]; then
                env=key4hep-release
            elif [ "${{ matrix.build_type }}" = "nightly" ]; then
                env=key4hep-nightly-opt
                python3 /${name}/scripts/fetch_nightly_versions.py --path ${name}/environments/key4hep-common/packages.yaml --extra-path ${name}/environments/key4hep-nightly-opt/packages.yaml ""
            else
                echo "Unknown build type"
                exit 1
            fi
            cd /${name}/environments/${env}
            spack env activate .
            spack concretize

            EOF

            chmod +x ${GITHUB_WORKSPACE}/script_container.sh

            # cat ${GITHUB_WORKSPACE}/script_container.sh

            docker exec container /bin/bash -c "/mount.sh && /${name}/script_container.sh"
